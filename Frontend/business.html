<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Information Dashboard</title>
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="styles/business.css">
</head>
<body>
    <div class="business-info-container">
        <h2>Business Dashboard</h2>
        <div id="businessInfoContent">
            <!-- Info will be loaded here -->
        </div>
        
        <div id="businessServicesContent"></div>
        
        <h3>Your Events</h3>
        <div id="businessEvents" class="events-list">
            <!-- Events will be loaded here -->
        </div>
        
        <div class="action-buttons">
            <button onclick="window.location.href='index.html'" class="action-button">Back to Home</button>
            <button onclick="window.location.href='realtimechat.html'" class="action-button">Chat with Clients</button>
            <button id="addServiceBtn" class="action-button">Add Service</button>
        </div>
    </div>
        <!-- Add Service Modal -->
        <div id="addServiceModal">
            <div class="modal-content">
                <button onclick="closeAddServiceModal()" class="modal-close">&times;</button>
                <h2>Add Service</h2>
                <form id="addServiceForm">
                    <div class="form-group">
                        <label class="form-label" for="eventType">Event Type:</label>
                        <select id="eventType" name="eventType" required class="form-control">
                            <option value="">Select...</option>
                            <option value="Wedding">Wedding</option>
                            <option value="Party">Party</option>
                            <option value="Meeting">Meeting</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="priceRange">Price Range:</label>
                        <input type="text" id="priceRange" name="priceRange" placeholder="e.g. 10,000-20,000" required class="form-control" />
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="venueExperience">Experience with Venues:</label>
                        <div id="venueList" class="venue-list"></div>
                    </div>
                    <button type="submit" class="action-button">Save Service</button>
                    <div id="addServiceError" class="error-message"></div>
                    <div id="addServiceSuccess" class="success-message"></div>
                </form>
            </div>
        </div>
    <script src="scripts/business.js">
        const API_BASE = 'http://localhost:8080';

        function renderBusinessInfo() {
            const infoDiv = document.getElementById('businessInfoContent');
            const business = JSON.parse(localStorage.getItem('businessInfo'));
            if (!business) {
                infoDiv.innerHTML = '<div style="color:#dc2626;">No business info found. Please login again.</div>';
                return;
            }
            infoDiv.innerHTML = `
                <div class="info-row"><span class="info-label">ID:</span> <span class="info-value">${business.id}</span></div>
                <div class="info-row"><span class="info-label">Email:</span> <span class="info-value">${business.email || '-'}</span></div>
                <div class="info-row"><span class="info-label">Company Name:</span> <span class="info-value">${business.companyName || '-'}</span></div>
                <div class="info-row"><span class="info-label">Phone:</span> <span class="info-value">${business.phone || '-'}</span></div>
                <div class="info-row"><span class="info-label">Role:</span> <span class="info-value">${business.role || '-'}</span></div>
            `;
            renderBusinessServices(business.id);
            fetchBusinessEvents();
        }

        async function renderBusinessServices(businessId) {
            const servicesDiv = document.getElementById('businessServicesContent');
            servicesDiv.innerHTML = '<h3 style="color:#059669;">Your Services</h3><div>Loading...</div>';
            try {
                // Fetch latest business info from backend to get services
                const resp = await fetch(`${API_BASE}/api/business/${businessId}`);
                if (!resp.ok) throw new Error('Failed to fetch business services');
                const business = await resp.json();
                // Also update business info section with latest data
                const infoDiv = document.getElementById('businessInfoContent');
                infoDiv.innerHTML = `
                    <div class="info-row"><span class="info-label">ID:</span> <span class="info-value">${business.id}</span></div>
                    <div class="info-row"><span class="info-label">Email:</span> <span class="info-value">${business.email || '-'} </span></div>
                    <div class="info-row"><span class="info-label">Company Name:</span> <span class="info-value">${business.companyName || '-'} </span></div>
                    <div class="info-row"><span class="info-label">Phone:</span> <span class="info-value">${business.phone || '-'} </span></div>
                    <div class="info-row"><span class="info-label">Role:</span> <span class="info-value">${business.role || '-'} </span></div>
                `;
                const services = business.services || [];
                if (!services.length) {
                    servicesDiv.innerHTML = '<h3 style="color:#059669;">Your Services</h3><div style="color:#6b7280;">No services added yet.</div>';
                    return;
                }
                servicesDiv.innerHTML = '<h3 style="color:#059669;">Your Services</h3>' +
                  services.map((service, idx) => `
                    <div style="border:1px solid #e5e7eb;border-radius:8px;padding:12px;margin-bottom:12px;">
                        <div><strong>Event Type:</strong> ${service.eventType}</div>
                        <div><strong>Price Range:</strong> ${service.priceRange}</div>
                        <div><strong>Experience with Venues:</strong> ${service.venueIds && service.venueIds.length ? service.venueIds.join(', ') : 'None'}</div>
                    </div>
                  `).join('');
            } catch (err) {
                servicesDiv.innerHTML = '<h3 style="color:#059669;">Your Services</h3><div style="color:#dc2626;">Error loading services.</div>';
            }
        }

        async function fetchBusinessEvents() {
            const business = JSON.parse(localStorage.getItem('businessInfo'));
            if (!business) return;

            try {
                const response = await fetch(`${API_BASE}/api/venues/bookings/business?companyName=${encodeURIComponent(business.companyName)}`, {
    headers: {
        'X-Business-Id': business.id,
        'X-Business-Email': business.email
    }
});

                if (!response.ok) {
                    throw new Error('Failed to fetch events');
                }

                const events = await response.json();
                renderEvents(events);
            } catch (error) {
                const eventsDiv = document.getElementById('businessEvents');
                eventsDiv.innerHTML = '<div style="color: #dc2626;">Failed to load events. Please try again later.</div>';
            }
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        function renderEvents(events) {
            const eventsDiv = document.getElementById('businessEvents');
            
            if (!events || events.length === 0) {
                eventsDiv.innerHTML = '<div style="color: #6b7280;">No events found.</div>';
                return;
            }

            const eventsHtml = events.map((event, index) => `
                <div class="event-item" onclick="toggleEventDetails(${index})">
                    <div class="event-title">${event.venueName}</div>
                    <div class="event-details" id="event-details-${index}">
                        <div class="event-detail-row">
                            <strong>Date(s):</strong> ${event.selectedDates.map(date => formatDate(date)).join(', ')}
                        </div>
                        <div class="event-detail-row">
                            <strong>Status:</strong> ${event.status}
                        </div>
                        <div class="event-detail-row">
                            <strong>Booking Date:</strong> ${formatDate(event.bookingDate)}
                        </div>
                        ${event.totalAmount ? `             
                        ` : ''}
                    </div>
                </div>
            `).join('');

            eventsDiv.innerHTML = eventsHtml;
        }

        function toggleEventDetails(index) {
            const detailsDiv = document.getElementById(`event-details-${index}`);
            detailsDiv.classList.toggle('show');
        }

        renderBusinessInfo();
                // Add Service Modal logic
                document.getElementById('addServiceBtn').onclick = function() {
                    openAddServiceModal();
                };

                function openAddServiceModal() {
                    document.getElementById('addServiceModal').style.display = 'flex';
                    document.body.style.overflow = 'hidden';
                    loadVenueList();
                }
                function closeAddServiceModal() {
                    document.getElementById('addServiceModal').style.display = 'none';
                    document.body.style.overflow = 'auto';
                    document.getElementById('addServiceError').style.display = 'none';
                    document.getElementById('addServiceSuccess').style.display = 'none';
                }

                async function loadVenueList() {
                    const venueListDiv = document.getElementById('venueList');
                    venueListDiv.innerHTML = '<div style="color:#6b7280;">Loading venues...</div>';
                    try {
                        // Use working API call from user.js
                        const response = await fetch(`${API_BASE}/api/venues/all`);
                        if (!response.ok) throw new Error('Failed to fetch venues');
                        const venues = await response.json();
                        if (!venues || venues.length === 0) {
                            venueListDiv.innerHTML = '<div style="color:#6b7280;">No venues found.</div>';
                            return;
                        }
                        venueListDiv.innerHTML = venues.map(venue => `
                            <label style="display:block;margin-bottom:6px;">
                                <input type="checkbox" name="venueExperience" value="${venue.id}" /> ${venue.venueName}
                            </label>
                        `).join('');
                    } catch (err) {
                        venueListDiv.innerHTML = '<div style="color:#dc2626;">Error loading venues.</div>';
                    }
                }

                document.getElementById('addServiceForm').onsubmit = async function(e) {
                    e.preventDefault();
                    const business = JSON.parse(localStorage.getItem('businessInfo'));
                    if (!business) {
                        showAddServiceError('Business info not found. Please login again.');
                        return;
                    }
                    const eventType = document.getElementById('eventType').value;
                    const priceRange = document.getElementById('priceRange').value.trim();
                    const venueCheckboxes = document.querySelectorAll('input[name="venueExperience"]:checked');
                    const venueIds = Array.from(venueCheckboxes).map(cb => cb.value);
                    if (!eventType || !priceRange) {
                        showAddServiceError('Please fill all required fields.');
                        return;
                    }
                    // Save service to backend
                    try {
                        const payload = {
                            businessId: business.id,
                            eventType,
                            priceRange,
                            venueIds
                        };
                        const resp = await fetch(`${API_BASE}/api/business/service`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-Business-Id': business.id,
                                'X-Business-Email': business.email
                            },
                            body: JSON.stringify(payload)
                        });
                        if (!resp.ok) {
                            const err = await resp.json();
                            throw new Error(err.message || 'Failed to save service');
                        }
                        showAddServiceSuccess('Service added successfully!');
                        setTimeout(closeAddServiceModal, 1200);
                    } catch (err) {
                        showAddServiceError(err.message);
                    }
                };

                function showAddServiceError(msg) {
                    const errDiv = document.getElementById('addServiceError');
                    errDiv.textContent = msg;
                    errDiv.style.display = 'block';
                    document.getElementById('addServiceSuccess').style.display = 'none';
                }
                function showAddServiceSuccess(msg) {
                    const succDiv = document.getElementById('addServiceSuccess');
                    succDiv.textContent = msg;
                    succDiv.style.display = 'block';
                    document.getElementById('addServiceError').style.display = 'none';
                }
    </script>
</body>
</html>

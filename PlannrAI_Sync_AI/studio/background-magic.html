<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Background Magic - PlannrAI</title>
    <link rel="stylesheet" href="master-tool.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="back-button">
                <a href="index.html">‚Üê Back to Studio</a>
            </div>
            <h1>üé≠ Background Magic</h1>
            <p>Remove backgrounds instantly with AI precision</p>
        </header>

        <div class="main-content">
            <div class="tool-form">
                <form id="backgroundForm">
                    <div class="form-group">
                        <label for="imageUpload">Upload Your Image</label>
                        <div class="file-upload-area" id="fileUploadArea">
                            <input type="file" id="imageUpload" accept="image/*" required style="display: none;">
                            <div class="upload-content">
                                <div class="upload-icon">üñºÔ∏è</div>
                                <p>Click to upload or drag and drop</p>
                                <span class="upload-hint">PNG, JPG, WebP (max 25MP, 30MB)</span>
                            </div>
                        </div>
                        <div class="uploaded-image" id="uploadedImage" style="display: none;">
                            <img id="previewImage" alt="Uploaded image">
                            <button type="button" class="change-image-btn" onclick="changeImage()">Change Image</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Use Cases</label>
                        <div class="use-cases">
                            <span class="use-case">üì∏ Product Photos</span>
                            <span class="use-case">üë§ Profile Pictures</span>
                            <span class="use-case">üé® Design Elements</span>
                            <span class="use-case">üé™ Event Graphics</span>
                        </div>
                    </div>

                    <button type="submit" class="generate-btn" id="removeBtn">
                        <span class="btn-icon">‚ú®</span>
                        <span class="btn-text">Remove Background</span>
                    </button>
                </form>
            </div>

            <div class="chat-container">
                <div class="chat-header">
                    <h3>üé≠ Background Removal Results</h3>
                    <button class="clear-chat" onclick="clearChat()">Clear All</button>
                </div>
                
                <div class="chat-messages" id="chatMessages">
                    <div class="message welcome-message">
                        <div class="message-header">
                            <strong>Welcome to Background Magic!</strong>
                        </div>
                        <p>Remove backgrounds from your images with AI precision. Perfect for:</p>
                        <ul>
                            <li>üì∏ Creating product catalogs</li>
                            <li>üë§ Profile picture cleanup</li>
                            <li>üé® Design element extraction</li>
                            <li>üì± Social media content</li>
                            <li>üé™ Event promotional materials</li>
                        </ul>
                        <div class="tip-box">
                            <strong>üí° Tip:</strong> For best results, use images with clear subject-background separation.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class BackgroundMagicTool {
            constructor() {
                this.chatMessages = document.getElementById('chatMessages');
                this.currentFile = null;
                this.initializeEventListeners();
            }

            initializeEventListeners() {
                // Form submission
                document.getElementById('backgroundForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.removeBackground();
                });

                // File upload area
                const fileUploadArea = document.getElementById('fileUploadArea');
                const fileInput = document.getElementById('imageUpload');

                fileUploadArea.addEventListener('click', () => {
                    fileInput.click();
                });

                fileUploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    fileUploadArea.classList.add('drag-over');
                });

                fileUploadArea.addEventListener('dragleave', () => {
                    fileUploadArea.classList.remove('drag-over');
                });

                fileUploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    fileUploadArea.classList.remove('drag-over');
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        this.handleFileUpload(files[0]);
                    }
                });

                fileInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        this.handleFileUpload(e.target.files[0]);
                    }
                });
            }

            handleFileUpload(file) {
                if (!file.type.startsWith('image/')) {
                    this.showToast('Please upload an image file', 'error');
                    return;
                }

                // Check file size (30MB limit)
                if (file.size > 30 * 1024 * 1024) {
                    this.showToast('Image file is too large. Maximum size is 30MB.', 'error');
                    return;
                }

                this.currentFile = file;
                
                // Show preview
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('previewImage').src = e.target.result;
                    document.getElementById('fileUploadArea').style.display = 'none';
                    document.getElementById('uploadedImage').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }

            async removeBackground() {
                if (!this.currentFile) {
                    this.showToast('Please upload an image first', 'error');
                    return;
                }

                const removeBtn = document.getElementById('removeBtn');
                const originalText = removeBtn.querySelector('.btn-text').textContent;
                
                removeBtn.querySelector('.btn-text').textContent = 'Removing...';
                removeBtn.disabled = true;

                try {
                    const formData = new FormData();
                    formData.append('image_file', this.currentFile);

                    const response = await fetch('/remove-background', {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        // Response is an image blob
                        const imageBlob = await response.blob();
                        const imageUrl = URL.createObjectURL(imageBlob);
                        
                        this.displayBackgroundResult(this.currentFile.name, imageUrl);
                        this.showToast('Background removed successfully!', 'success');
                        
                        // Log credits info if available
                        const remainingCredits = response.headers.get('x-remaining-credits');
                        const creditsConsumed = response.headers.get('x-credits-consumed');
                        if (remainingCredits) {
                            console.log(`Credits remaining: ${remainingCredits}, consumed: ${creditsConsumed}`);
                        }
                    } else {
                        // Try to parse error message
                        let errorMessage = 'Failed to remove background';
                        try {
                            const errorData = await response.json();
                            errorMessage = errorData.detail || errorMessage;
                        } catch (e) {
                            errorMessage = `Server error: ${response.status}`;
                        }
                        throw new Error(errorMessage);
                    }
                } catch (error) {
                    console.error('Error removing background:', error);
                    this.showToast(error.message || 'Failed to remove background. Please try again.', 'error');
                } finally {
                    removeBtn.querySelector('.btn-text').textContent = originalText;
                    removeBtn.disabled = false;
                }
            }

            displayBackgroundResult(originalName, imageUrl) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message assistant-message';
                
                messageDiv.innerHTML = `
                    <div class="message-header">
                        <strong>Background Removed</strong>
                        <span class="timestamp">${new Date().toLocaleTimeString()}</span>
                    </div>
                    <div class="original-info">
                        <strong>Original:</strong> ${originalName}
                    </div>
                    <div class="result-comparison">
                        <div class="result-image">
                            <img src="${imageUrl}" alt="Background removed" style="max-width: 100%; border-radius: 8px; margin-top: 10px;">
                            <div class="transparent-bg-preview" style="background: linear-gradient(45deg, #ccc 25%, transparent 25%, transparent 75%, #ccc 75%, #ccc), linear-gradient(45deg, #ccc 25%, white 25%, white 75%, #ccc 75%, #ccc); background-size: 20px 20px; background-position: 0 0, 10px 10px; padding: 20px; margin: 10px 0; border-radius: 8px;">
                                <img src="${imageUrl}" alt="Background removed with transparency preview" style="max-width: 100%; border-radius: 8px;">
                            </div>
                        </div>
                    </div>
                    <div class="image-actions">
                        <button onclick="downloadImage('${imageUrl}', 'no-bg-${originalName}')" class="download-btn">üì• Download PNG</button>
                        <button onclick="processAnother()" class="regenerate-btn">üîÑ Process Another</button>
                    </div>
                `;
                
                // Remove welcome message if it exists
                const welcomeMessage = this.chatMessages.querySelector('.welcome-message');
                if (welcomeMessage) {
                    welcomeMessage.remove();
                }
                
                this.chatMessages.appendChild(messageDiv);
                this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
            }

            showToast(message, type = 'info') {
                const toast = document.createElement('div');
                toast.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#2196F3'};
                    color: white;
                    padding: 15px 20px;
                    border-radius: 8px;
                    z-index: 1001;
                    font-weight: 500;
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                    transform: translateX(100%);
                    transition: transform 0.3s ease;
                `;
                
                toast.textContent = message;
                document.body.appendChild(toast);
                
                // Animate in
                setTimeout(() => {
                    toast.style.transform = 'translateX(0)';
                }, 100);
                
                // Remove after 3 seconds
                setTimeout(() => {
                    toast.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        toast.remove();
                    }, 300);
                }, 3000);
            }
        }

        // Global functions for button actions
        window.downloadImage = function(imageUrl, filename) {
            const link = document.createElement('a');
            link.href = imageUrl;
            link.download = `${filename}-${Date.now()}.png`;
            link.click();
        };

        window.processAnother = function() {
            window.changeImage();
        };

        window.changeImage = function() {
            document.getElementById('fileUploadArea').style.display = 'block';
            document.getElementById('uploadedImage').style.display = 'none';
            document.getElementById('imageUpload').value = '';
            backgroundMagic.currentFile = null;
        };

        window.clearChat = function() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = `
                <div class="message welcome-message">
                    <div class="message-header">
                        <strong>Welcome to Background Magic!</strong>
                    </div>
                    <p>Remove backgrounds from your images with AI precision. Perfect for:</p>
                    <ul>
                        <li>üì∏ Creating product catalogs</li>
                        <li>üë§ Profile picture cleanup</li>
                        <li>üé® Design element extraction</li>
                        <li>üì± Social media content</li>
                        <li>üé™ Event promotional materials</li>
                    </ul>
                    <div class="tip-box">
                        <strong>üí° Tip:</strong> For best results, use images with clear subject-background separation.
                    </div>
                </div>
            `;
        };

        // Initialize the tool when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            window.backgroundMagic = new BackgroundMagicTool();
        });
    </script>
</body>
</html>
